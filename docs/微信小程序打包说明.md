# JSZip 微信小程序专用打包说明

## 概述

为了解决微信小程序代码保护机制无法解析 browserify 生成的动态 `require` 检测代码问题，新增了基于 Rollup 的打包方式，专门生成微信小程序兼容的版本。

## 新增文件

- `rollup.config.js` - Rollup 构建配置
- 生成文件：
  - `dist/jszip.mp.js` - 未压缩版本（适合开发调试）
  - `dist/jszip.mp.min.js` - 压缩版本（适合生产环境）

## 使用方法

### 1. 安装依赖

```bash
npm install
```

### 2. 构建微信小程序版本

```bash
npm run build:mp
```

或使用 Grunt：

```bash
grunt build:mp
```

### 3. 在微信小程序中引入

在小程序项目中引入生成的文件：

```javascript
const JSZip = require('./libs/jszip.mp.min.js');

// 使用示例
const zip = new JSZip();
zip.file("hello.txt", "Hello World!");
zip.generateAsync({type:"blob"}).then(function(content) {
  // ...
});
```

## 技术细节

### 为什么需要单独打包？

**问题根源：**
- 原有的 browserify 打包生成的 UMD 包装器包含 `typeof require=="function"&&require` 这样的动态检测
- 微信小程序的代码保护工具无法解析这种表达式，导致上传失败

**Rollup 解决方案：**
- Rollup 生成的 UMD 格式更简洁、现代
- 不使用动态 `require` 检测，天然兼容小程序环境
- 生成的代码更小，性能更好

### 与原有构建的区别

| 特性 | browserify (原有) | Rollup (小程序) |
|------|------------------|----------------|
| 命令 | `npm run build` | `npm run build:mp` |
| 输出文件 | `jszip.js`, `jszip.min.js` | `jszip.mp.js`, `jszip.mp.min.js` |
| UMD 格式 | 传统包装器 | 现代简洁格式 |
| 小程序兼容 | ❌ 需手动修改 | ✅ 开箱即用 |
| 文件大小 | 较大 | 较小（Tree-shaking）|

### 构建配置说明

**Rollup 配置项：**
- `format: 'umd'` - 生成 UMD 格式，兼容多种模块系统
- `name: 'JSZip'` - 全局变量名
- `exports: 'default'` - 默认导出
- `browser: true` - 浏览器环境优化
- `preferBuiltins: false` - 不使用 Node.js 内置模块

**插件说明：**
- `@rollup/plugin-replace` - 替换版本号占位符
- `@rollup/plugin-node-resolve` - 解析 node_modules 依赖
- `@rollup/plugin-commonjs` - 转换 CommonJS 为 ES6
- `@rollup/plugin-terser` - 压缩代码（仅用于 .min 版本）

## 维护说明

### 升级 JSZip 版本后

无需任何额外操作，直接运行：

```bash
npm run build:mp
```

即可生成新版本的小程序兼容文件。

### 原有构建不受影响

原有的 `npm run build` 命令仍然可用，两种构建方式互不干扰：

```bash
npm run build      # 生成 jszip.js, jszip.min.js（原有方式）
npm run build:mp   # 生成 jszip.mp.js, jszip.mp.min.js（小程序）
```

## 故障排查

### 如果构建失败

1. 检查 Node.js 版本（建议 14.0+）
2. 清理并重新安装依赖：
   ```bash
   rm -rf node_modules package-lock.json
   npm install
   ```
3. 检查 Rollup 插件版本是否兼容

### 如果小程序仍然报错

1. 确认使用的是 `.mp.js` 或 `.mp.min.js` 版本
2. 检查小程序开发者工具的代码保护设置
3. 尝试使用未压缩版本 `.mp.js` 进行调试

## 相关文件

- `rollup.config.js` - Rollup 构建配置
- `Gruntfile.js` - Grunt 任务配置（包含 build:mp 任务）
- `package.json` - npm 脚本配置

## 参考资料

- [Rollup 官方文档](https://rollupjs.org/)
- [微信小程序文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [JSZip 官方文档](https://stuk.github.io/jszip/)

